<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“é£›æ©Ÿæ—¥å¸¸ç´€éŒ„ - æ‰“é£›æ©Ÿæ—¥å¸¸ç´€éŒ„</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>Â  
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>Â  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">Â  
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #1e3c72, #2a5298); color: #fff; min-height: 100vh; }Â  
        .container { max-width: 900px; }Â  
        .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .hero { padding: 4rem 0; text-align: center; }Â  
        .hero h1 { font-size: 3rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .hero p { font-size: 1.2rem; opacity: 0.9; }
        .form-control, .form-select { background: rgba(255,255,255,0.2); border: none; color: #fff; }
        .form-control::placeholder { color: rgba(255,255,255,0.7); }
        .btn-primary { background: #ff6b6b; border: none; transition: all 0.3s; }Â  
        .btn-primary:hover { background: #ff8787; transform: translateY(-2px); }
        .table { background: rgba(255,255,255,0.15); }
        .table th, .table td { border: none; }
        footer { margin-top: 5rem; padding: 2rem 0; text-align: center; opacity: 0.7; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- ç™»å…¥é é¢ -->
        <div id="loginSection" class="text-center hero">Â  
            <h1>âœˆï¸ ç§äººé£›è¡Œæ—¥èªŒ</h1>
            <p class="lead">æ­¡è¿ä¾†åˆ°ä½ çš„ç§äººç´€éŒ„ç©ºé–“ã€‚<br>é€™è£¡åªå±¬æ–¼ä½ è‡ªå·±</p>
            <div class="card mx-auto mt-5 p-4" style="max-width: 400px;">Â  
                <h4>ä½¿ç”¨ Email ç™»å…¥</h4>Â  
                <div class="mb-3">
                    <input type="email" id="loginEmail" class="form-control" placeholder="è¼¸å…¥ä½ çš„ Email">Â  
                </div>
                <button id="sendLinkBtn" class="btn btn-primary w-100">ç™¼é€emailç™»å…¥é€£çµ</button>Â  
                <p id="loginMsg" class="mt-3 text-warning"></p>
            </div>
        </div>

        <!-- ä¸»æ‡‰ç”¨é é¢ -->
        <div id="appSection" class="d-none">Â  
            <div class="hero">
                <h1>âœˆï¸ æ­¡è¿å›ä¾†ï¼Œ<span id="userNickname">é£›è¡Œå“¡</span>ï¼</h1>Â  
                <p>ä»Šå¤©ä¹Ÿå¾ˆé©åˆä¾†ä¸€ç™¼ã€‚</p>Â  
            </div>

            <!-- ä¿®æ”¹æš±ç¨± -->
            <div class="card p-4 mb-4">Â  
                <h5>ä¿®æ”¹æš±ç¨±</h5>
                <div class="input-group">Â  
                    <input type="text" id="nicknameInput" class="form-control" placeholder="è¼¸å…¥æ–°æš±ç¨±">
                    <button id="updateNicknameBtn" class="btn btn-primary">æ›´æ–°</button>
                </div>
            </div>

            <!-- è¨˜éŒ„é£›è¡Œ -->
            <div class="card p-4 mb-5">
                <h5>ç™¼å°„æˆåŠŸ</h5>Â  
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>æ—¥æœŸ</label>Â  
                        <input type="date" id="recordDate" class="form-control">Â  
                    </div>
                    <div class="col-md-4">Â  Â  
                        <label>æ™‚é–“ï¼ˆå¤§ç´„ï¼‰</label>
                        <select id="recordHour" class="form-select"></select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">Â  
                        <button id="addRecordBtn" class="btn btn-primary w-100">è¨˜éŒ„</button>Â  
                    </div>
                </div>
            </div>

            <!-- æœˆæ’è¡Œæ¦œ -->
            <div class="card p-4">
                <h5>ğŸªœ æœ¬æœˆæ’è¡Œæ¦œï¼ˆå‰ 50 åï¼‰</h5>
                <div id="leaderboardLoading" class="text-center py-4">è¼‰å…¥ä¸­...</div>
                <table class="table table-hover text-white d-none" id="leaderboardTable">Â  
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æš±ç¨±</th>
                            <th>æ¬¡æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>

            <div class="text-center mt-4">
                <button id="logoutBtn" class="btn btn-outline-light">ç™»å‡º</button>Â  
            </div>
        </div>
    </div>

    <footer>
        <p>å…è²¬è²æ˜ï¼šæ­¤ç¶²ç«™åƒ…ç”¨æ–¼å€‹äººè¿½è¸ªï¼Œåªæœ‰å¨›æ¨‚åƒ¹å€¼ï¼Œä¸æä¾›å…¶ä»–é¡å¤–çš„æœå‹™ã€‚</p>
    </footer>

    <script>
        // â†â†â†â†â†â†â†â†â†â†â†â†â†â† é€™è£¡è¦æŠŠä½ å‰›å‰›è¤‡è£½çš„ firebaseConfig è²¼é€²ä¾† â†â†â†â†â†â†â†â†â†â†â†â†â†â†
        const firebaseConfig = {
              apiKey: "AIzaSyDub01y9nvtEKGrVg6DWLYVwVlBs2YFgxs",
              authDomain: "diy-daily-record.firebaseapp.com",
              projectId: "diy-daily-record",
              storageBucket: "diy-daily-record.firebasestorage.app",Â  Â  
              messagingSenderId: "1030894380378",
              appId: "1:1030894380378:web:16b1ce08b6a4e51f1e3f63",
              measurementId: "G-NPT3TLF0PK"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // æ™‚é–“é¸å–® 00-23
        const hourSelect = document.getElementById('recordHour');
        for (let i = 0; i < 24; i++) {
            const opt = document.createElement('option');
            opt.value = i.toString().padStart(2, '0');
            opt.textContent = i.toString().padStart(2, '0') + ':00';
            hourSelect.appendChild(opt);
        }

        // é è¨­ä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();

        // é­”æ³•é€£çµè¨­å®š
        const actionCodeSettings = {
            url: window.location.href.split('?')[0],  // è¿”å›ç›®å‰é é¢
            handleCodeInApp: true
        };

        // ç™¼é€ç™»å…¥é€£çµ
        document.getElementById('sendLinkBtn').onclick = () => {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) return alert('è«‹è¼¸å…¥ Email');Â  
            document.getElementById('loginMsg').textContent = 'ç™¼é€ä¸­...';
            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    document.getElementById('loginMsg').textContent = 'å·²ç™¼é€åˆ°ä½ çš„ä¿¡ç®±ï¼è«‹å»æ”¶ä¿¡ä¸¦é»æ“Šé€£çµç™»å…¥ï¼ˆä¹Ÿæª¢æŸ¥åƒåœ¾éƒµä»¶ï¼‰';
                })
                .catch(err => alert('éŒ¯èª¤ï¼š' + err.message));
        };

        // å¦‚æœæ˜¯å¾éƒµä»¶é»å›ä¾†çš„
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) email = prompt('è«‹å†è¼¸å…¥ä¸€æ¬¡ä½ çš„ Email');
            auth.signInWithEmailLink(email, window.location.href)
                .then(() => window.localStorage.removeItem('emailForSignIn'))
                .catch(err => alert('ç™»å…¥å¤±æ•—ï¼š' + err.message));
        }

        // ç™»å…¥ç‹€æ…‹ç›£è½
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').classList.add('d-none');
                document.getElementById('appSection').classList.remove('d-none');
                loadNickname(user);
                loadLeaderboard();
            } else {
                document.getElementById('loginSection').classList.remove('d-none');
                document.getElementById('appSection').classList.add('d-none');
            }
        });

        function loadNickname(user) {
            db.collection('users').doc(user.uid).get().then(doc => {
                const nick = doc.exists && doc.data().nickname ? doc.data().nickname : 'é£›è¡Œå“¡';
                document.getElementById('userNickname').textContent = nick;
                document.getElementById('nicknameInput').value = nick;
            });
        }

        // æ›´æ–°æš±ç¨±
        document.getElementById('updateNicknameBtn').onclick = () => {
            const nick = document.getElementById('nicknameInput').value.trim() || 'åŒ¿åé£›è¡Œå“¡';
            db.collection('users').doc(auth.currentUser.uid).set({nickname: nick}, {merge: true})
                .then(() => {
                    document.getElementById('userNickname').textContent = nick;
                    alert('æš±ç¨±æ›´æ–°æˆåŠŸï¼');
                });
        };

        // è¨˜éŒ„é£›è¡Œ
        document.getElementById('addRecordBtn').onclick = () => {
            const date = document.getElementById('recordDate').value;
            const hour = document.getElementById('recordHour').value;
            if (!date) return alert('è«‹é¸æ—¥æœŸ');
            const month = date.substring(0,7); // YYYY-MM

            db.collection('records').add({
                uid: auth.currentUser.uid,
                date: date,
                month: month,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('å·²è¨˜éŒ„æœ¬æ¬¡é£›è¡Œ âœˆï¸');
                loadLeaderboard();
            });
        };

        // è¼‰å…¥æ’è¡Œæ¦œ
        function loadLeaderboard() {
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');

            db.collection('records').where('month', '==', currentMonth).get()
                .then(snapshot => {
                    const counts = {};
                    snapshot.forEach(doc => {
                        const uid = doc.data().uid;
                        counts[uid] = (counts[uid] || 0) + 1;
                    });

                    const promises = Object.keys(counts).map(uid =>
                        db.collection('users').doc(uid).get().then(doc => ({
                            uid,
                            count: counts[uid],
                            nickname: doc.exists && doc.data().nickname || 'åŒ¿åé£›è¡Œå“¡'
                        }))
                    );

                    Promise.all(promises).then(entries => {
                        entries.sort((a,b) => b.count - a.count);
                        const tbody = document.getElementById('leaderboardBody');
                        tbody.innerHTML = '';
                        entries.slice(0,50).forEach((e, i) => {
                            tbody.innerHTML += `<tr><td>${i+1}</td><td>${e.nickname}</td><td>${e.count}</td></tr>`;
                        });
                        document.getElementById('leaderboardLoading').classList.add('d-none');
                        document.getElementById('leaderboardTable').classList.remove('d-none');
                    });
                });
        }

        // ç™»å‡º
        document.getElementById('logoutBtn').onclick = () => auth.signOut();
    </script>
</body>
</html>
